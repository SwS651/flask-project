{% extends 'base.html' %}
{% block css_style %} 

    <link rel="stylesheet" href="{{url_for('static',filename='css/flex.css')}}"> 
    <link rel="stylesheet" href="{{url_for('static',filename='css/grid.css')}}"> 
    <link rel="stylesheet" href="{{url_for('static',filename='css/table.css')}}"> 
    <link rel="stylesheet" href="{{url_for('static',filename='css/form.css')}}"> 
    <link rel="stylesheet" href="{{url_for('static',filename='css/modal.css')}}"> 

{% endblock %}
{% block nav_checkout %}active{% endblock %}
{% block content %}


    <div class="flex flex-between-end" style="padding: 1rem 0 0 0;">
        <div class="container_item">
            <p>Sale ID: {{sale.id}} </p>
            <p>Date: {{sale.Date}} </p>
            <p>Staff: {{sale.Staff_id}} </p>
        </div>
        <div class="container_item">
    
            <input type="text" id="search_field" onkeyup="prodcut_search()" placeholder="Search for Barcode" title="Type in a barcode">
        </div>
    </div>

    <div class="grid-container four-two-grid">
        <div class="grid-item">
            <div class="table-container maxheight-800 scrollable">
                <table id="product_list">
                    <tr>
                        <th>Barcode</th>
                        <th>Product Name</th>
                        <th>QTY</th>
                        <th></th>
                    </tr>
                    
                    {% for product in products %}
                    {% set available_QTY = product.Inventories | map(attribute='Available_QTY') | sum %}
                    <tr>
                    <td>{{product.BarCode}}</td>
                    <td>{{product.Name}}</td>
                    <td>{{available_QTY}}</td>
                    <td><a href="{{url_for("sale.add_sale_item",item = product.id)}}"><i class='bx bxs-add-to-queue'></i></a></td>
                </tr>
                {% endfor %}
                </table>
                
            </div>
        </div>
        <div class="grid-item">
            <h3>Check Out</h3>
            <div class="table-container">

                <table class="">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>QTY</th>
                        <th>SalePrice</th>
                        <th></th>
                    </tr>
                    {% if sale %}
                    {% for item in sale.Sale_items %}
                    <tr>
                        <td>{{ item.id }}</td>
                        <td>
                            {% for product in products %}
                            {% for inventory in product.Inventories %}
                            {% if inventory.id == item.Inventory_id %}
                           
                            {{product.Name}}
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                        </td>
                        <td>{{ item.Quantity }}</td>
                        <td>{{ item.SalePrice }}</td>
                        <td><a href="{{url_for('sale.remove_sale_item_from_checkout',item = item.id)}}"><i class='bx bx-minus'></i></a></td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </table>
            </div>
            <div class="form-container">
                <h3>Payment</h3>
                <form action="{{url_for('sale.finalize_checkout',id = sale.id)}}" method="post">
                    <label for="type_payment">Type Payment</label>
                    <input type="text" name="type_payment" placeholder="Cash, E-Wallet, Other..." value="Cash" autocomplete=False required>
                    <label for="refer">No. Refer</label>
                    <input type="text" name="no_refer" placeholder="0000 000 000" value="" autocomplete=False required>
                   
                    <label for="tax">Tax: <span id="tax"></span></label>
                    <input type="number" name="tax" placeholder="tax" value="0" min="0.00" step="0.01" required>
                    <p >subtotal: <span id="subtotal">{{sale.Total}}</span></p><br><br><br>
                    <label for="discount">Discount</label>
                    <input type="number" name="discount" placeholder="0%" value="0" min="0.00" step="0.01" required>
                    <label for="Total">Total</label>
                    <input type="number" name="total" placeholder="Total Amount" value="0" min="0.00" step="0.01" required>
                    <label for="customPrice">Save Custom Total Price</label>
                    <input type="checkbox" name="custom_price" id="" value="True"><br><br>
                    <input type="submit" class="button success" value="End Payment">
                </form>
            </div>
        </div>
    </div>

    
{% endblock %}

{% block jscontent %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const taxInput = document.querySelector("input[name='tax']");
            const discountInput = document.querySelector("input[name='discount']");
            const subtotal = parseFloat(document.getElementById('subtotal').innerText);
            console.log(subtotal)
            // Function to calculate total amount
            function calculateTotal() {
                const tax = parseFloat(taxInput.value);
                const discount = parseFloat(discountInput.value);
                const total = parseFloat((subtotal + (subtotal*(tax/100))) - (subtotal *(discount/100))).toFixed(2);
                document.querySelector("input[name='total']").value = total;
            }

            // Add event listeners to tax and discount inputs
            taxInput.addEventListener("input", calculateTotal);
            discountInput.addEventListener("input", calculateTotal);

            // Initially calculate total amount
            calculateTotal();
        });
    </script>

    <script>
        function prodcut_search(){
           // Declare variables
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("search_field");
            filter = input.value.toUpperCase();
            table = document.getElementById("product_list");
            tr = table.getElementsByTagName("tr");

            // Loop through all table rows, and hide those who don't match the search query
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
                }
            }
        }

    
    </script>

{% endblock %}